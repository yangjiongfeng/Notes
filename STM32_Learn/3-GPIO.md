# 3-STM32 GPIO
>引用来自[STM32 （三）GPIO的八种模式及其原理](https://blog.csdn.net/DOF526570/article/details/128367242)


## 一、GPIO简介
>GPIO：通用I/O(输入/输出)端口，是STM32可控制的引脚。
>STM32芯片的GPIO引脚与外部设备连接起来，可实现与外部通讯、控制外部硬件或者采集外部硬件数据的功能。

## 二、GPIO工作模式.

#### 输出模式（4种）
>开漏输出模式 ：GPIO_Mode_Out_OD 
>推挽输出模式 ：GPIO_Mode_Out_PP 
>复用开漏输出模式 ：GPIO_Mode_AF_OD 
>复用推挽输出模式 ：GPIO_Mode_AF_PP 


# 三、GPIO工作原理解析
### 1. I/O端口的基本结构框图
![这是图片](D:/Notes/STM32_Learn/picture/IO端口得基本结构框图.png "Magic Gardens")

### 2. 元器件作用

**保护二极管**
>作用： 防止引脚外部输入过高和过低的电压，防止不正常电压引入芯片，导致芯片烧毁。
>当引脚电压高于VDD时，上方的二极管导通。
>当引脚电压低于VSS时，下方的二极管导通。


**上拉电阻和下拉电阻**
作用： 控制引脚默认状态的电压。
开启上拉的时候，引脚默认电压为高电平。
开启下拉的时候，引脚默认电压为低电平



**TTL肖特基触发器**
TTL肖特基触发器其实可以理解为用肖特基管构成的施密特触发器。
作用： 将相对缓慢变化的模拟信号变成矩形信号。
当输入电压高于正向阈值电压，输出为高。
当输入电压低于负向阈值电压，输出为低。


**P-MOS管和N-MOS管**
作用： 使得GPIO具有“推挽输出”和“开漏输出”的模式。
P-MOS管： MCU输出为 1 导通，低电平关闭。
N-MOS管： MCU输出为 0 导通，高电平关闭。


### 3. GPIO工作模式解析
**3-1 浮空输入模式**
>I/O端口的电平信号直接进入到**输入数据寄存器**。  
MCU直接读取I/O口电平，I/O的电平状态是不确定的，完全由外部输入决定。
![这是图片](D:/Notes/STM32_Learn/picture/浮空输入模式.png)



| I/O引脚              | MCU读取 | 
| :------------------: | :----: | 
| 引脚悬空外部无信号输入 | 不确定 | 
| 高电平                | 高电平 | 
| 低电平                | 低电平 | 
>**在引脚悬空（在无信号输入）的情况下，读取该端口的电平是不确定的。 (接用电压表测量其引脚电压为1点几伏，这是个不确定值**) 以用来做KEY识别

**3-2 上拉输入模式**
I/O端口的电平信号经过上拉电阻进入到输入数据寄存器。

| I/O引脚              | MCU读取 | 
| :------------------: | :----: | 
| 引脚悬空外部无信号输入 | 高电平 | 
| 高电平                | 高电平 | 
| 低电平                | 低电平 | 

![这是图片](D:/Notes/STM32_Learn/picture/上拉输入模式.png)
>IO内部接上拉电阻，此时如果IO口外部没有信号输入或者引脚悬空，IO口默认为高电平  如果I/O口输入低电平，那么引脚就为低电平，MCU读取到的就是低电平*IO内部接上拉电阻，此时如果IO口外部没有信号输入或者引脚悬空，IO口默认为高电平  如果I/O口输入低电平，那么引脚就为低电平，MCU读取到的就是低电平
>IO内部接上拉电阻，此时如果IO口外部没有信号输入或者引脚悬空，IO口默认为高电平  如果I/O口输入低电平，那么引脚就为低电平，MCU读取到的就是低电平

**3-3 下拉输入模式**
**下拉输入模式下，** I/O端口的电平信号经过下拉电阻进入到输入数据寄存器。

| I/O引脚              | MCU读取 | 
| :------------------: | :----: | 
| 引脚悬空外部无信号输入 | 低电平 | 
| 高电平                | 高电平 | 
| 低电平                | 低电平 | 
![这是图片](D:/Notes/STM32_Learn/picture/下拉输入模式.png)

>  IO内部接下拉电阻，此时如果IO口外部没有信号输入或者引脚悬空，IO口默认为低电平  如果I/O口输入高电平，那么引脚就为高电平，MCU读取到的就是高电平。


**3-4 模拟输入模式**
**模拟输入模式下，** I/O端口的电平信号不经过TTL肖特基触发器，直接进入ADC模块，并且输入数据寄存器为空 ，MCU不能在输入数据寄存器上读到引脚状态。  
在模拟输入模式下，上拉电阻和下拉电阻是不起作用的，即使配置上拉和下拉模式，也不会有作用。
![这是图片](D:/Notes/STM32_Learn/picture/模拟输入模式.png)
当GPIO引脚用于ADC采集电压的输入通道时，用作"模拟输入"功能，此时信号不经过施密特触发器，直接直接进入ADC模块，并且输入数据寄存器为空 ，CPU不能在输入数据寄存器上读到引脚状态

当GPIO用于模拟功能时，引脚的上、下拉电阻是不起作用的，这个时候即使配置了上拉或下拉模式，也不会影响到模拟信号的输入输出

除了 ADC 和 DAC 要将 IO 配置为模拟通道之外其他外设功能一律 要配置为复用功能模式，


**3-5 开漏输出模式（带上拉或者下拉）**
**开漏输出模式下，** P-MOS管不工作，只有N-MOS管工作，MCU只能控制输出低电平。  
MCU输出低电平的时候，N-MOS管导通，I/O引脚输出低电平。  
MCU输出高电平的时候，N-MOS管关闭，I/O引脚悬空状态
![这是图片](D:/Notes/STM32_Learn/picture/开漏输出模式.png)

**3-6 推挽输出模式**
**推挽输出模式下，** P-MOS管和N-MOS管都工作，MCU可以控制输出高电平和低电平。  
MCU输出为 **0** 的时候，N-MOS管导通，I/O引脚输出低电平。  
MCU输出为 **1** 的时候，P-MOS管导通，I/O引脚输出高电平
![这是图片](D:/Notes/STM32_Learn/picture/推挽输出模式.png)



**3-7 复用开漏输出模式**
**复用开漏输出模式下，** GPIO复用为其他外设，输出数据寄存器GPIOx_ODR无效， 输出的高低电平的来源于其它外设
![这是图片](D:/Notes/STM32_Learn/picture/复用开漏输出模式.png)

**3-8 复用推挽输出模式**
**复用推挽输出模式下，** GPIO复用为其他外设，输出数据寄存器GPIOx_ODR无效， 输出的高低电平的来源于其它外设
![这是图片](D:/Notes/STM32_Learn/picture/复用推挽输出模式.png)






# STM32F103

>每个 IO 端口都有 7 个寄存器来控制
>配置模式（2个32位）：CRL  CRH
>输入/输出数据寄存器（2个32位）：IDR ODR
>置位/复位寄存器（1个32位）： BSRR
>复位寄存器（1个16位）： BRR
>锁存寄存器（1个32位）：LCKR

端口低配置寄存器CRL各位描述

![这是图片](D:/Notes/STM32_Learn/picture/寄存器CRL各位描述.png)

寄存器复位值：0X4444 4444 = 0100 0100 0100 0100   0100 0100 0100 0100 (二进制)


          端口配置       端口模式
0100 ：浮空                输入模式

常用配置：
0X0（0000）  ： 模拟输入模式（ADC 用） 
0X3（0011）  ： 推挽输出（50M速率）
0X8（1000）  ：上/下拉输入模式
0XB（1011）  ：复用输出（50M速率）


**IDR    端口输入寄存器**
只读权限，只用低16位
![这是图片](D:/Notes/STM32_Learn/picture/IDR端口输入数据寄存器.jpg)

读取IO端口数据函数：uint8_t GPIO_ReadInputDataBit(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin)

**ODR    端口输出寄存器**
读写权限，只用低16位
![这是图片](D:/Notes/STM32_Learn/picture/ODR端口输出数据寄存器.jpg)

控制 IO 口的输出状态的函数：void GPIO_Write(GPIO_TypeDef* GPIOx, uint16_t PortVal);